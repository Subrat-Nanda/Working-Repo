CREATE DATABASE  IF NOT EXISTS `my_books_sn` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */ /*!80016 DEFAULT ENCRYPTION='N' */;
USE `my_books_sn`;
-- MySQL dump 10.13  Distrib 8.0.32, for Win64 (x86_64)
--
-- Host: localhost    Database: my_books_sn
-- ------------------------------------------------------
-- Server version	8.0.32

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!50503 SET NAMES utf8 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Table structure for table `customer_order_line`
--

DROP TABLE IF EXISTS `customer_order_line`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!50503 SET character_set_client = utf8mb4 */;
CREATE TABLE `customer_order_line` (
  `cust_line_id` int NOT NULL AUTO_INCREMENT,
  `order_id` int DEFAULT NULL,
  `book_id` int DEFAULT NULL,
  `quantity` int DEFAULT '1',
  `price` double DEFAULT NULL,
  PRIMARY KEY (`cust_line_id`),
  KEY `fk_cust_ordline_order` (`order_id`),
  KEY `fk_cust_ordline_book` (`book_id`),
  CONSTRAINT `fk_cust_ordline_book` FOREIGN KEY (`book_id`) REFERENCES `book` (`book_id`) ON DELETE CASCADE,
  CONSTRAINT `fk_cust_ordline_order` FOREIGN KEY (`order_id`) REFERENCES `cust_order` (`order_id`) ON DELETE CASCADE,
  CONSTRAINT `customer_order_line_chk_1` CHECK ((`quantity` > 0))
) ENGINE=InnoDB AUTO_INCREMENT=569 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `customer_order_line`
--

LOCK TABLES `customer_order_line` WRITE;
/*!40000 ALTER TABLE `customer_order_line` DISABLE KEYS */;
INSERT INTO `customer_order_line` VALUES (1,1,6677,24,5064),(2,2,4857,21,5486),(3,3,1440,11,4642),(4,4,505,11,5486),(5,5,913,23,5908),(6,6,5339,19,8440),(7,7,10566,21,5064),(8,8,9441,21,10550),(9,9,1364,20,6330),(10,10,3608,20,6330),(11,11,3268,16,9284),(12,12,5338,24,4642),(13,13,8496,20,5908),(14,14,480,18,6752),(15,15,10862,19,7596),(16,16,3834,13,7174),(17,17,1487,15,4642),(18,18,10272,17,10550),(19,19,9349,14,10128),(20,20,4720,15,5064),(21,21,4930,22,5486),(22,22,7035,17,9706),(23,23,10925,14,9706),(24,24,6347,15,8018),(25,25,1343,23,10128),(26,26,2334,15,8018),(27,27,2038,13,6752),(28,28,9232,24,5908),(29,29,8524,25,9706),(30,30,6184,14,5908),(31,31,6461,11,7596),(32,32,1669,11,7174),(33,33,4622,21,5064),(34,34,3908,14,10550),(35,35,9350,14,7596),(36,36,8761,14,8440),(37,37,28,10,5908),(38,38,1017,20,10128),(39,39,1911,25,10128),(40,40,5670,22,6752),(41,41,9670,13,8440),(42,42,9150,13,4642),(43,43,7417,13,10128),(44,44,427,15,5908),(45,45,2164,14,10550),(46,46,6603,11,5908),(47,47,8962,14,4220),(48,48,2185,24,5486),(49,49,1563,10,7174),(50,50,3061,24,5908),(51,51,86,13,7596),(52,52,4319,14,7596),(53,53,5883,10,8862),(54,54,10223,16,8862),(55,55,3482,17,6752),(56,56,10236,16,5486),(57,57,2295,16,7174),(58,58,2814,24,8862),(59,59,558,25,9284),(60,60,8178,14,6330),(61,61,590,13,6752),(62,62,7532,12,10550),(63,63,10086,18,8440),(64,64,978,17,10550),(65,65,8235,21,7596),(66,66,8315,11,8018),(67,67,4217,13,5064),(68,68,5298,25,6752),(69,69,6979,24,8862),(70,70,6529,21,5486),(71,71,5368,21,10128),(72,72,10507,24,8862),(73,73,9117,24,10128),(74,74,6274,10,4642),(75,75,586,11,8018),(76,76,4359,14,8440),(77,77,1466,19,8862),(78,78,5157,12,5908),(79,79,3359,21,5486),(80,80,239,17,6752),(81,81,10190,15,4642),(82,82,4420,20,5064),(83,83,1052,25,4220),(84,84,2797,14,9284),(85,85,6328,16,8440),(86,86,8134,21,7174),(87,87,7688,11,5064),(88,88,8883,20,4642),(89,89,9676,13,6330),(90,90,7031,11,5064),(91,91,3438,12,8862),(92,92,8841,22,8440),(93,93,5770,19,9706),(94,94,5708,23,7174),(95,95,10618,15,9284),(96,96,8543,16,8440),(97,97,845,15,9284),(98,98,9725,10,6752),(99,99,7049,23,4220),(100,100,5632,17,7596),(101,101,3479,25,8018),(102,102,2874,18,7596),(103,103,3204,22,4220),(104,104,9531,13,5908),(105,105,5276,19,8440),(106,106,2848,14,7596),(107,107,4462,15,7174),(108,108,9115,21,6330),(109,109,5636,17,6330),(110,110,4524,11,6330),(111,111,4763,11,7174),(112,112,10059,12,4220),(113,113,4485,10,5064),(114,114,372,23,7174),(115,115,9336,20,9284),(116,116,1114,11,5064),(117,117,4406,19,8440),(118,118,7913,17,5486),(119,119,9717,23,7596),(120,120,10488,10,7596),(121,121,6384,15,5064),(122,122,5028,24,8440),(123,123,5915,19,6752),(124,124,8142,16,5064),(125,125,10563,16,9284),(126,126,4099,17,6752),(127,127,5258,13,8440),(128,128,2902,15,4642),(129,129,1990,21,7596),(130,130,2494,18,4220),(131,131,4541,24,8440),(132,132,9331,13,8018),(133,133,6698,14,4642),(134,134,6134,19,8440),(135,135,3855,22,9706),(136,136,2052,14,8018),(137,137,2259,14,7174),(138,138,7855,12,7174),(139,139,7915,11,5064),(140,140,9023,20,8440),(141,141,6114,21,8862),(142,142,8893,21,6330),(143,143,7257,15,5486),(144,144,10823,15,5908),(145,145,9139,14,4642),(146,146,10563,19,6330),(147,147,1051,16,9706),(148,148,5641,24,6752),(149,149,2801,11,6330),(150,150,3307,16,6752),(151,151,6222,20,9706),(152,152,8085,25,8018),(153,153,10680,24,6752),(154,154,4042,20,8018),(155,155,9688,20,5486),(156,156,2501,17,7174),(157,157,6484,18,7596),(158,158,7547,20,5064),(159,159,4893,21,6330),(160,160,9946,16,10128),(161,161,11126,13,8862),(162,162,6401,19,5486),(163,163,3600,11,5486),(164,164,4466,17,8018),(165,165,5312,18,5064),(166,166,2661,22,5908),(167,167,4134,10,9284),(168,168,724,24,8862),(169,169,2559,23,10128),(170,170,6969,14,5908),(171,171,2347,13,9706),(172,172,6840,16,5486),(173,173,8560,14,5486),(174,174,975,22,10128),(175,175,8540,25,5486),(176,176,1866,13,8862),(177,177,4078,19,4642),(178,178,1355,16,6330),(179,179,1052,18,8018),(180,180,6468,12,9284),(181,181,8072,15,8862),(182,182,8488,18,9706),(183,183,9898,22,4642),(184,184,3751,19,8440),(185,185,6687,11,7174),(186,186,9158,20,4220),(187,187,7055,12,5064),(188,188,9031,21,7174),(189,189,471,21,5486),(190,190,8693,16,9706),(191,191,6225,12,5486),(192,192,6988,18,9284),(193,193,1255,11,5486),(194,194,9367,18,10550),(195,195,7022,13,5486),(196,196,3048,21,6752),(197,197,9609,12,4642),(198,198,141,23,6330),(199,199,4662,12,8018),(200,200,7696,21,9284),(201,201,3346,10,5486),(202,202,1475,12,8862),(203,203,1214,14,6330),(204,204,7744,16,6330),(205,205,9977,18,10550),(206,206,1947,24,10550),(207,207,4540,12,6330),(208,208,8587,22,8862),(209,209,7582,14,6330),(210,210,2551,13,6330),(211,211,5068,14,8018),(212,212,7417,18,7174),(213,213,8445,17,7174),(214,214,3899,16,10550),(215,215,8006,20,5908),(216,216,4719,16,7174),(217,217,2125,18,6752),(218,218,1884,18,8440),(219,219,6865,10,6330),(220,220,10203,18,8018),(221,221,6024,23,6752),(222,222,4824,11,8862),(223,223,9476,25,8018),(224,224,104,15,7596),(225,225,2493,18,8862),(226,226,1248,15,6330),(227,227,3611,18,4642),(228,228,2567,23,9284),(229,229,9602,25,6752),(230,230,3665,15,5064),(231,231,821,10,4220),(232,232,7306,14,6752),(233,233,2615,11,6752),(234,234,4802,25,6752),(235,235,11092,21,9706),(236,236,10755,12,8440),(237,237,8965,11,8018),(238,238,714,18,4642),(239,239,8412,18,8862),(240,240,1253,17,5908),(241,241,4618,16,4220),(242,242,2737,12,7596),(243,243,8410,12,7174),(244,244,3571,12,5486),(245,245,9557,20,4220),(246,246,6845,11,10128),(247,247,5023,16,8440),(248,248,373,12,4642),(249,249,10478,17,5064),(250,250,3230,24,8018),(256,1,3489,22,6752),(257,2,459,11,6330),(258,3,8382,21,9706),(259,4,751,21,8018),(260,5,1701,11,9706),(261,6,10860,14,8440),(262,7,4363,11,9706),(263,8,5024,19,5486),(264,9,1424,12,6330),(265,10,3692,19,9284),(266,11,5150,10,5064),(267,12,9845,24,8440),(268,13,24,10,7174),(269,14,819,24,5908),(270,15,1106,21,10128),(271,16,1667,23,4220),(272,17,3920,20,7596),(273,18,8017,10,7174),(274,19,6801,20,8018),(275,20,3376,22,5486),(276,21,6474,15,9284),(277,22,50,20,5064),(278,23,4886,21,7174),(279,24,2916,24,5908),(280,25,3708,22,8018),(281,26,940,18,5064),(282,27,11114,19,8440),(283,28,8525,22,8862),(284,29,10123,14,8018),(285,30,11074,12,10128),(286,31,7786,20,7174),(287,32,4666,21,5486),(288,33,1749,13,8018),(289,34,10728,11,4642),(290,35,10748,19,6752),(291,36,2762,10,9284),(292,37,10285,13,5908),(293,38,10668,24,8018),(294,39,10865,12,8018),(295,40,3216,19,6330),(296,41,419,12,5486),(297,42,5704,24,8018),(298,43,8688,12,8018),(299,44,3532,23,8018),(300,45,7304,17,8862),(301,46,5048,10,5908),(302,47,4976,16,8440),(303,48,7430,15,5064),(304,49,9151,20,4220),(305,50,103,10,10128),(306,51,6243,12,9706),(307,52,7860,10,8862),(308,53,9578,11,7174),(309,54,390,23,5064),(310,55,3361,11,5908),(311,56,8839,13,6330),(312,57,58,24,5486),(313,58,5146,21,10128),(314,59,2314,15,10550),(315,60,9743,17,6330),(316,61,5722,17,5908),(317,62,5278,19,7174),(318,63,561,23,8018),(319,64,9773,19,8862),(320,65,2043,20,8018),(321,66,9571,18,5486),(322,67,1932,14,5908),(323,68,9807,19,6330),(324,69,3020,16,5064),(325,70,8033,14,7174),(326,71,7070,21,4642),(327,72,5436,13,10128),(328,73,1258,22,9284),(329,74,2369,19,7596),(330,75,9694,22,4642),(331,76,6789,22,8862),(332,77,7896,15,4642),(333,78,33,24,4642),(334,79,6236,20,5486),(335,80,57,17,7596),(336,81,4088,15,6752),(337,82,6856,23,9284),(338,83,6480,17,5486),(339,84,9539,20,5064),(340,85,10055,11,5064),(341,86,5919,15,7596),(342,87,3058,22,9284),(343,88,2138,19,6752),(344,89,7198,11,7174),(345,90,3724,14,6330),(346,91,4610,10,6330),(347,92,101,11,4642),(348,93,6164,19,9706),(349,94,3337,24,9284),(350,95,11053,17,7596),(351,96,4778,19,8018),(352,97,9324,17,4642),(353,98,7226,10,9706),(354,99,9826,21,9706),(355,100,3393,24,8018),(356,101,676,17,4642),(357,102,1796,18,8440),(358,103,5126,15,4642),(359,104,10729,20,6752),(360,105,4851,11,8440),(361,106,4780,12,9706),(362,107,397,18,9284),(363,108,5209,10,8018),(364,109,7551,20,7596),(365,110,9702,20,8440),(366,111,1422,20,5064),(367,112,2399,20,4220),(368,113,6802,10,5486),(369,114,2492,18,7174),(370,115,3523,12,9284),(371,116,5149,23,8440),(372,117,1157,18,5908),(373,118,1981,12,8862),(374,119,7269,11,6330),(375,120,7497,17,7596),(376,121,2133,15,7596),(377,122,2237,18,4220),(378,123,4876,11,7174),(379,124,278,19,7174),(380,125,1081,12,9284),(381,126,3394,12,8440),(382,127,8421,23,8018),(383,128,9964,20,6752),(384,129,9593,13,9284),(385,130,2181,19,5064),(386,131,4708,22,9706),(387,132,2985,23,6752),(388,133,8452,20,5486),(389,134,9285,19,9706),(390,135,7691,23,9706),(391,136,5501,23,10128),(392,137,6728,13,9706),(393,138,4063,14,5486),(394,139,3046,23,10550),(395,140,3800,22,9706),(396,141,10702,12,4642),(397,142,2784,11,10550),(398,143,10299,21,10128),(399,144,2600,15,5908),(400,145,2033,11,4642),(401,146,8371,18,10550),(402,147,2979,16,6752),(403,148,9930,15,9706),(404,149,4832,18,9706),(405,150,7438,23,6330),(406,151,1350,20,5486),(407,152,5384,23,7596),(408,153,1707,13,5486),(409,154,4760,17,8440),(410,155,3495,19,8862),(411,156,1142,14,10128),(412,157,8744,13,5486),(413,158,2790,21,5486),(414,159,3975,13,4220),(415,160,2729,13,5908),(416,161,2326,13,8440),(417,162,9341,14,5908),(418,163,238,13,7174),(419,164,3959,15,7596),(420,165,3395,23,10128),(421,166,9302,15,5064),(422,167,540,22,7174),(423,168,10647,17,7174),(424,169,3054,24,9706),(425,170,7064,17,10550),(426,171,5944,20,9284),(427,172,9083,19,4642),(428,173,8006,15,5486),(429,174,7660,23,7596),(430,175,9566,22,8440),(431,176,1532,20,7174),(432,177,6748,20,8440),(433,178,9635,13,5064),(434,179,9945,12,5908),(435,180,4857,17,8440),(436,181,3874,21,6330),(437,182,914,17,7596),(438,183,10831,15,8440),(439,184,2708,12,7596),(440,185,6994,19,6752),(441,186,10132,15,5064),(442,187,4720,22,6752),(443,188,8349,18,5486),(444,189,109,16,8862),(445,190,6798,24,4220),(446,191,8422,22,9284),(447,192,1683,15,4642),(448,193,6521,22,10128),(449,194,8702,12,9706),(450,195,8648,16,9284),(451,196,2767,22,7596),(452,197,3948,14,10550),(453,198,6256,22,7174),(454,199,1301,14,6752),(455,200,6458,20,4642),(456,201,6727,21,5486),(457,202,4097,13,7174),(458,203,3631,13,10128),(459,204,1466,21,9284),(460,205,8387,15,8862),(461,206,9937,15,8018),(462,207,3053,19,6752),(463,208,8816,23,4642),(464,209,6027,18,4642),(465,210,6877,23,8862),(466,211,1592,19,5064),(467,212,279,20,8440),(468,213,298,12,10128),(469,214,2002,13,8018),(470,215,6212,11,6752),(471,216,10287,15,8862),(472,217,10048,14,9706),(473,218,9717,20,5486),(474,219,4365,16,8018),(475,220,9275,15,5908),(476,221,1614,25,6330),(477,222,2588,13,5908),(478,223,482,18,8440),(479,224,336,12,7596),(480,225,9704,22,5064),(481,226,7846,13,6330),(482,227,2501,13,5486),(483,228,3,15,6752),(484,229,9959,15,7596),(485,230,10855,14,7596),(486,231,1379,12,6752),(487,232,5576,15,6330),(488,233,9432,13,5486),(489,234,2097,16,4642),(490,235,11076,21,8862),(491,236,1901,21,5908),(492,237,10989,13,8018),(493,238,10177,21,8862),(494,239,8059,16,8862),(495,240,4093,19,9706),(496,241,5856,10,8440),(497,242,7950,18,7174),(498,243,5022,23,5064),(499,244,10490,14,5486),(500,245,9057,17,8018),(501,246,9401,18,6330),(502,247,9849,15,5908),(503,248,2041,11,6752),(504,249,2584,24,10128),(505,250,8850,13,8018),(511,130,4625,11,4642),(512,16,9311,12,5064),(513,158,5619,17,7174),(514,156,4688,11,4642),(515,97,10714,22,9284),(516,25,7929,18,7596),(517,151,4515,25,10550),(518,1,4087,21,8862),(519,82,5582,16,6752),(520,48,6857,25,10550),(526,245,5760,19,8018),(527,202,3847,20,8440),(528,76,3895,21,8862),(529,87,4500,25,10550),(530,199,7652,16,6752),(531,134,9328,12,5064),(532,207,10744,21,8862),(533,16,8047,18,7596),(534,118,9883,15,6330),(535,211,6098,20,8440),(541,70,8489,22,9284),(542,177,9373,13,5486),(543,1,1127,17,7174),(544,88,1140,17,7174),(545,170,1811,22,9284),(546,151,6769,25,10550),(547,57,2512,11,4642),(548,17,188,24,10128),(549,156,4873,11,4642),(550,162,9465,12,5064),(556,242,3058,16,6752),(557,97,7483,15,6330),(558,6,5534,17,7174),(559,162,742,15,6330),(560,134,4364,24,10128),(561,246,2659,12,5064),(562,106,10579,20,8440),(563,211,5622,17,7174),(564,243,3,24,10128),(565,199,10533,20,8440),(567,257,1,2,422),(568,257,1,2,844);
/*!40000 ALTER TABLE `customer_order_line` ENABLE KEYS */;
UNLOCK TABLES;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8mb4 */ ;
/*!50003 SET character_set_results = utf8mb4 */ ;
/*!50003 SET collation_connection  = utf8mb4_0900_ai_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `before_is_available` BEFORE INSERT ON `customer_order_line` FOR EACH ROW begin
declare
order_id,avl_qty int default null;
set @order_id := NEW.order_id;
IF NEW.quantity <= 0 THEN
SIGNAL SQLSTATE '50001' SET MESSAGE_TEXT = 'PLEASE ENTER A VALID BOOK QUANTITY';
END IF; 
SELECT Warehouse.available_quantity into avl_qty
                   FROM Warehouse
                   WHERE Warehouse.book_id = NEW.book_id
                   and Warehouse.store_id =  (select store_id from Cust_Order where Cust_Order.order_id = @order_id limit 1)
                   LIMIT 1;
/*
IF NEW.quantity > (SELECT Warehouse.available_quantity
                   FROM Warehouse
                   WHERE Warehouse.book_id = NEW.book_id
                   and Warehouse.store_id =  (select store_id from Cust_Order where Cust_Order.order_id = @order_id limit 1)
                   LIMIT 1)
*/
IF ( NEW.quantity > avl_qty )  -- Checking condition when Ordered Quantity is grather than available quantity or 
THEN
begin
UPDATE cust_order SET status_Id = 6 WHERE cust_order.order_id = @order_id;
set @message_text = concat('NOT AVAILABLE - ORDER QUANTITY EXCEEDS AVAILABLE QUANTITY - AVAILABLE_BOOK_QTY = ' , avl_qty);
SIGNAL SQLSTATE '50002' SET MESSAGE_TEXT = @message_text;
end;
END IF;
IF NEW.quantity <= (SELECT Warehouse.available_quantity
                   FROM Warehouse
                   WHERE Warehouse.book_id = NEW.book_id
                   and Warehouse.store_id =  (select store_id from Cust_Order where Cust_Order.order_id = @order_id limit 1)
                   LIMIT 1)
THEN
UPDATE Warehouse SET Warehouse.available_quantity = Warehouse.available_quantity-new.quantity 
WHERE new.book_id = Warehouse.book_id and store_id = (select store_id from Cust_Order where Cust_Order.order_id = @order_id limit 1) limit 1;
END IF;
end */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2023-02-17 17:20:52
